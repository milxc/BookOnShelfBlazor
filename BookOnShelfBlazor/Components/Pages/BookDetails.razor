@page "/BookDetails/{BookId:int}"

@using Microsoft.EntityFrameworkCore
@using BookOnShelfBlazor.Data
@using Microsoft.AspNetCore.Components
@using Microsoft.Extensions.DependencyInjection
@using Microsoft.AspNetCore.Identity
@using BookOnShelfBlazor.Data.Models
@inject ApplicationDbContext Context

@inject NavigationManager NavigationManager
@rendermode InteractiveServer

<h3 class="text-center">Book Details</h3>

<div class="container">
    @if (Book != null)
    {
        <div class="card">
            <div class="card-body">
                <div class="image-container">
                    @if (ShowFrontImage)
                    {
                        <img src="@(GetImageSource(Book.FrontCover))" class="front-cover" alt="Front Cover" />
                    }
                    else
                    {
                        <img src="@(GetImageSource(Book.BackCover))" class="back-cover" alt="Back Cover" />
                    }
                    <hr />
                    <button class="toggle-picture-button" @onclick="ToggleImage"><i class="bi bi-arrow-left-right"></i></button>
                </div>
                <div class="BookDescription" style="max-width:50%">
                    <div class="text-center">
                        <h4 class="card-title">@Book.Title</h4>
                    </div>
                    <hr />
                    <p class="w-100">@Book.Description</p>
                </div>
                <div class="BookInfo" style="max-width:25%">
                    <div class="text-center">
                        <h4 class="card-title">Book Info</h4>
                        <hr />
                        <p>Amount of pages:<br />@Book.AmountOfPages</p>
                        <hr />
                        <p>ISBN:<br />@Book.ISBN</p>
                        <hr />
                        <p>Genre:<br />@Book.GenreId.GenreName</p>
                        <hr />
                        <p>Language:<br />@Book.LanguageId.LanguageName</p>
                        <hr />
                    </div>
                </div>
                @foreach (var writer in Writers)
                {
                    <div class="WriterInfo">
                        <hr />
                        <div class="image-container">
                            <img src="@(GetImageSource(writer.ProfilePicture))" class="writer-image" alt="Writer Image" />
                            <hr />
                            <div class="text-center w-100">
                                   @writer.FirstName @if(writer.MiddleName != null){@writer.MiddleName} @writer.LastName
                            </div>
                        </div>

                        <div class="AboutTheWriter">
                            <div class="text-center">
                                <h4>About the writer:</h4>
                            </div>
                            <hr />
                            <p>@writer.Description</p>
                        </div>

                    </div>
                }
            </div>
        </div>
    }
    else
    {
        <p class="text-center">Book not found.</p>
    }
</div>

@code {
    [Parameter]
    public int BookId { get; set; }

    public Books Book;

    public List<Writers> Writers = new List<Writers>();

    private bool ShowFrontImage = true;

    protected async override Task OnInitializedAsync()
    {
        Book = Context.Books
            .Include(book => book.GenreId)
            .Include(book => book.LanguageId)
            .FirstOrDefault(book => book.BookId == BookId);

        Writers = await Context.BooksWriters
        .Include(bw => bw.WritersId)
            .Where(bw => bw.Bookid == Book)
            .Select(bw => bw.WritersId)
            .ToListAsync();
    }


    private string GetImageSource(byte[] imageData)
    {
        if (imageData == null || imageData.Length == 0)
            return null;

        return $"data:image/jpeg;base64,{Convert.ToBase64String(imageData)}";
    }

    private void ToggleImage()
    {
        ShowFrontImage = !ShowFrontImage;
    }
}
